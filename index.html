<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>লাভ ক্যালকুলেটর - অ্যাডমিন প্যানেল</title>
  <!-- Tailwind CSS and custom fonts for modern design -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Poppins', 'Noto Sans Bengali', sans-serif;
      color: #333;
    }
    .bg-gradient-love {
      background-image: linear-gradient(to right, #6b21a8, #88138d, #be185d);
    }
    .btn-primary {
      @apply w-full px-6 py-3 bg-pink-600 text-white font-semibold rounded-xl hover:bg-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg;
    }
    .bg-sidebar {
      background-color: #6a1b9a;
    }
    .hover\:bg-sidebar-light:hover {
      background-color: #7b1fa2;
    }
    .active-link {
      background-color: #f06292;
      border-left: 4px solid #d81b60;
    }
    .text-shadow {
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .spinner {
      border-top-color: #f06292;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      animation: zoomIn 0.3s ease-out;
    }
    @keyframes zoomIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tab-content, .login-container {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Admin Login Page -->
  <div id="login-container" class="bg-gradient-love min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full transition-transform transform hover:scale-105 duration-500 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-purple-800">অ্যাডমিন প্যানেল</h1>
      <p class="text-gray-500 mt-2 mb-8">অনুগ্রহ করে লগইন করুন</p>
      
      <button id="google-login-btn" class="w-full flex items-center justify-center space-x-3 px-4 py-3 bg-white border border-gray-300 rounded-full font-semibold text-gray-700 hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
        <span>গুগল দিয়ে লগইন করুন</span>
      </button>

      <div id="login-status" class="mt-6 text-center">
        <div id="login-spinner" class="w-8 h-8 border-4 border-purple-500 border-t-transparent border-solid rounded-full animate-spin mx-auto hidden"></div>
        <p id="login-message" class="text-gray-600 mt-2"></p>
      </div>

    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-sidebar text-white shadow-xl flex flex-col fixed h-screen z-50">
      <div class="p-6 border-b border-purple-800 text-center">
        <h2 class="text-3xl font-bold text-pink-200">অ্যাডমিন</h2>
      </div>
      <nav class="flex-1 mt-4">
        <ul class="space-y-2 px-4">
          <li>
            <a href="#" data-tab="dashboard" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">dashboard</span>
              <span>ড্যাশবোর্ড</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="users" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">people</span>
              <span>ব্যবহারকারীগণ</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="activity" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">history</span>
              <span>সাম্প্রতিক কার্যকলাপ</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="history" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">list_alt</span>
              <span>সকল হিস্টরি</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="p-4 border-t border-purple-800">
        <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 p-3 bg-pink-500 rounded-xl text-lg font-semibold hover:bg-pink-600 transition-all duration-300 transform hover:scale-105">
          <span class="material-icons">logout</span>
          <span>লগআউট</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-64 p-8 transition-all duration-300">
      <header class="flex justify-between items-center pb-6 border-b border-gray-300 mb-8">
        <h1 id="page-title" class="text-4xl font-bold text-purple-800 text-shadow">ড্যাশবোর্ড</h1>
        <div class="flex items-center space-x-4">
          <img id="admin-photo" src="https://placehold.co/40x40/6a1b9a/ffffff?text=A" alt="Admin" class="w-12 h-12 rounded-full border-2 border-purple-600 shadow-md">
          <span id="admin-email" class="text-gray-700 font-medium hidden sm:block"></span>
        </div>
      </header>

      <!-- Loading Spinner -->
      <div id="main-loading-spinner" class="flex justify-center items-center h-[50vh] text-gray-500 hidden">
        <div class="w-16 h-16 border-4 border-gray-300 border-t-pink-500 rounded-full spinner"></div>
      </div>
      
      <!-- Dashboard Tab -->
      <div id="dashboard-tab" class="tab-content">
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">মোট ব্যবহারকারী</div>
            <div id="total-users" class="text-4xl font-bold mt-2 text-purple-700">0</div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">মোট গণনা</div>
            <div id="total-calculations" class="text-4xl font-bold mt-2 text-purple-700">0</div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">আজকের কার্যকলাপ</div>
            <div id="today-activity" class="text-4xl font-bold mt-2 text-purple-700">0</div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">গড় প্রেম শতাংশ</div>
            <div id="avg-percentage" class="text-4xl font-bold mt-2 text-purple-700">0%</div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-purple-800 mb-4">সাম্প্রতিক গণনা</h2>
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead>
                <tr class="bg-purple-800 text-white rounded-t-lg">
                  <th class="px-4 py-3 text-left rounded-tl-xl">ব্যবহারকারী</th>
                  <th class="px-4 py-3 text-left">নাম</th>
                  <th class="px-4 py-3 text-left">শতাংশ</th>
                  <th class="px-4 py-3 text-left rounded-tr-xl">সময়</th>
                </tr>
              </thead>
              <tbody id="latest-calculations" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users-tab" class="tab-content hidden">
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input type="text" id="user-search" placeholder="ব্যবহারকারী অনুসন্ধান করুন..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm">
          <button id="search-user-btn" class="bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md">অনুসন্ধান</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-purple-800 text-white rounded-t-lg">
                <th class="px-4 py-3 text-left rounded-tl-xl">ইমেল</th>
                <th class="px-4 py-3 text-left">সাইন আপ তারিখ</th>
                <th class="px-4 py-3 text-left">গণনা</th>
                <th class="px-4 py-3 text-left rounded-tr-xl">কার্যকলাপ</th>
              </tr>
            </thead>
            <tbody id="users-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Activity Tab -->
      <div id="activity-tab" class="tab-content hidden">
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input type="text" id="activity-search" placeholder="সাম্প্রতিক কার্যকলাপ অনুসন্ধান করুন..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm">
          <button id="search-activity-btn" class="bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md">অনুসন্ধান</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-purple-800 text-white rounded-t-lg">
                <th class="px-4 py-3 text-left rounded-tl-xl">ব্যবহারকারী</th>
                <th class="px-4 py-3 text-left">নাম</th>
                <th class="px-4 py-3 text-left">শতাংশ</th>
                <th class="px-4 py-3 text-left rounded-tr-xl">সময়</th>
              </tr>
            </thead>
            <tbody id="activity-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      
      <!-- All History Tab -->
      <div id="history-tab" class="tab-content hidden">
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input type="text" id="history-search" placeholder="হিস্টরি অনুসন্ধান করুন..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm">
          <button id="search-history-btn" class="bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md">অনুসন্ধান</button>
          <button id="clear-history-btn" class="bg-red-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-600 transition-all duration-300 transform hover:scale-105 shadow-md">সব হিস্টরি মুছে ফেলুন</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-purple-800 text-white rounded-t-lg">
                <th class="px-4 py-3 text-left rounded-tl-xl">ব্যবহারকারী</th>
                <th class="px-4 py-3 text-left">নাম</th>
                <th class="px-4 py-3 text-left">শতাংশ</th>
                <th class="px-4 py-3 text-left">সময়</th>
                <th class="px-4 py-3 text-left rounded-tr-xl">কার্যকলাপ</th>
              </tr>
            </thead>
            <tbody id="history-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Custom Confirmation Modal -->
  <div id="confirmation-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-3xl p-8 shadow-2xl max-w-sm w-full modal-content">
      <h3 class="text-xl font-bold text-gray-800 mb-4">নিশ্চিত করুন</h3>
      <p id="modal-text" class="text-gray-600 mb-6">আপনি কি এই কাজটি করতে চান?</p>
      <div class="flex justify-end space-x-4">
        <button id="cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold hover:bg-gray-400 transition-colors duration-200">বাতিল</button>
        <button id="confirm-btn" class="bg-red-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-red-600 transition-colors duration-200">নিশ্চিত করুন</button>
      </div>
    </div>
  </div>
  
  <!-- Loading Spinner Modal -->
  <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl">
      <div class="w-10 h-10 border-4 border-purple-500 border-t-transparent border-solid rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-700 font-medium">প্রক্রিয়াকরণ হচ্ছে...</p>
    </div>
  </div>

  <!-- Firebase SDK and custom script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, onSnapshot, collection, query, deleteDoc, writeBatch, collectionGroup, updateDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Firebase Configuration ---
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // --- DOM Elements ---
    // Login Page
    const loginContainer = document.getElementById('login-container');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const loginSpinner = document.getElementById('login-spinner');
    const loginMessage = document.getElementById('login-message');
    
    // Admin Panel
    const adminPanel = document.getElementById('admin-panel');
    const sidebarLinks = document.querySelectorAll('a[data-tab]');
    const tabContents = document.querySelectorAll('.tab-content');
    const pageTitleEl = document.getElementById('page-title');
    const logoutBtn = document.getElementById('logout-btn');
    const adminPhoto = document.getElementById('admin-photo');
    const adminEmailEl = document.getElementById('admin-email');
    const mainLoadingSpinner = document.getElementById('main-loading-spinner');
    
    // Dashboard
    const totalUsersEl = document.getElementById('total-users');
    const totalCalculationsEl = document.getElementById('total-calculations');
    const todayActivityEl = document.getElementById('today-activity');
    const avgPercentageEl = document.getElementById('avg-percentage');
    const latestCalculationsEl = document.getElementById('latest-calculations');
    
    // Users Tab
    const userSearchInput = document.getElementById('user-search');
    const searchUserBtn = document.getElementById('search-user-btn');
    const usersListEl = document.getElementById('users-list');
    
    // Activity Tab
    const activitySearchInput = document.getElementById('activity-search');
    const searchActivityBtn = document.getElementById('search-activity-btn');
    const activityListEl = document.getElementById('activity-list');
    
    // History Tab
    const historySearchInput = document.getElementById('history-search');
    const searchHistoryBtn = document.getElementById('search-history-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const historyListEl = document.getElementById('history-list');
    
    // Modals
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalText = document.getElementById('modal-text');
    const confirmBtn = document.getElementById('confirm-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const loadingModal = document.getElementById('loading-modal');
    
    // --- Global State & Constants ---
    let currentAdmin = null;
    let usersData = [];
    let allHistoryData = [];
    let isInitialDataLoaded = false;
    const ADMIN_EMAIL = "smartwork19999@gmail.com";

    // --- UI Functions ---
    function showLoginMessage(message, isError = false) {
      loginMessage.textContent = message;
      loginMessage.className = isError ? 'text-red-600 mt-2' : 'text-gray-600 mt-2';
    }

    function toggleLoginSpinner(show) {
        loginSpinner.classList.toggle('hidden', !show);
    }

    function showAdminPanel(show) {
        loginContainer.classList.toggle('hidden', show);
        adminPanel.classList.toggle('hidden', !show);
    }

    // --- Authentication ---
    onAuthStateChanged(auth, async (user) => {
        toggleLoginSpinner(false);
        if (user) {
            if (user.email === ADMIN_EMAIL) {
                // Admin successfully logged in
                currentAdmin = user;
                adminEmailEl.textContent = user.email;
                adminEmailEl.classList.remove('hidden');
                adminPhoto.src = user.photoURL || `https://placehold.co/40x40/6a1b9a/ffffff?text=${user.email[0].toUpperCase()}`;
                
                showAdminPanel(true);
                if (!isInitialDataLoaded) {
                    await loadInitialData();
                    isInitialDataLoaded = true;
                }
                switchTab('dashboard');
            } else {
                // Not an admin, sign them out
                showLoginMessage('প্রবেশাধিকার নেই। আপনি অ্যাডমিন নন।', true);
                await signOut(auth);
                showAdminPanel(false);
            }
        } else {
            // User is signed out
            currentAdmin = null;
            showAdminPanel(false);
            isInitialDataLoaded = false; // Reset data load flag on logout
            showLoginMessage(''); // Clear any previous messages
        }
    });

    googleLoginBtn.addEventListener('click', async () => {
        toggleLoginSpinner(true);
        showLoginMessage('গুগল দিয়ে সাইন ইন করা হচ্ছে...');
        try {
            await signInWithPopup(auth, googleProvider);
            // onAuthStateChanged will handle the rest
        } catch (error) {
            console.error("Google Sign-In Error:", error);
            showLoginMessage('গুগল লগইন ব্যর্থ হয়েছে। আবার চেষ্টা করুন।', true);
            toggleLoginSpinner(false);
        }
    });
    
    logoutBtn.addEventListener('click', async () => {
      loadingModal.classList.remove('hidden');
      try {
        await signOut(auth);
      } catch (error) {
        console.error("Logout failed:", error);
      } finally {
        loadingModal.classList.add('hidden');
      }
    });

    // --- Data Loading and Rendering ---
    async function loadInitialData() {
        mainLoadingSpinner.classList.remove('hidden');
        
        // Using Promise.all to fetch both collections concurrently
        await Promise.all([
            new Promise(resolve => {
                onSnapshot(collection(db, `artifacts/${appId}/public/users`), (snapshot) => {
                    usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    resolve();
                });
            }),
            new Promise(resolve => {
                onSnapshot(collectionGroup(db, 'history'), (snapshot) => {
                    allHistoryData = snapshot.docs.map(doc => {
                        const path = doc.ref.path.split('/');
                        const userId = path[path.indexOf('users') + 1];
                        return { id: doc.id, userId: userId, ...doc.data() };
                    });
                    resolve();
                });
            })
        ]);
        
        // Once all data is loaded, update the UI
        updateAllUI();
        mainLoadingSpinner.classList.add('hidden');
    }
    
    function updateAllUI() {
        loadDashboardData();
        renderUsersList();
        renderActivityList();
        renderHistoryList();
    }

    function loadDashboardData() {
      totalUsersEl.textContent = usersData.length;
      totalCalculationsEl.textContent = allHistoryData.length;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayActivityCount = allHistoryData.filter(h => h.timestamp?.toDate() >= today).length;
      todayActivityEl.textContent = todayActivityCount;
      
      const totalPercentage = allHistoryData.reduce((sum, h) => sum + (h.percentage || 0), 0);
      const avgPercentage = allHistoryData.length > 0 ? (totalPercentage / allHistoryData.length).toFixed(2) : 0;
      avgPercentageEl.textContent = `${avgPercentage}%`;
      
      renderLatestCalculations();
    }
    
    function renderLatestCalculations() {
      latestCalculationsEl.innerHTML = '';
      const latest = [...allHistoryData].sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).slice(0, 5);
      
      if (latest.length === 0) {
        latestCalculationsEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">কোন সাম্প্রতিক গণনা পাওয়া যায়নি।</td></tr>`;
        return;
      }

      latest.forEach(calc => {
        const user = usersData.find(u => u.id === calc.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${calc.loverName || 'অজানা'} ❤️ ${calc.partnerName || 'অজানা'}`;
        const time = calc.timestamp?.toDate().toLocaleString('bn-BD') || 'অজানা';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${userEmail}</td>
          <td class="px-4 py-3">${names}</td>
          <td class="px-4 py-3 font-semibold text-pink-600">${calc.percentage}%</td>
          <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
        `;
        latestCalculationsEl.appendChild(row);
      });
    }

    function renderUsersList(searchTerm = '') {
      usersListEl.innerHTML = '';
      const filteredUsers = usersData.filter(user => 
        !searchTerm || (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      
      if (filteredUsers.length === 0) {
          usersListEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">কোন ব্যবহারকারী পাওয়া যায়নি।</td></tr>`;
          return;
      }

      filteredUsers.forEach(user => {
        const signUpDate = user.signUpDate?.toDate().toLocaleDateString('bn-BD') || 'অজানা';
        const calculationCount = allHistoryData.filter(h => h.userId === user.id).length;
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${user.email || 'অজানা'}</td>
          <td class="px-4 py-3 text-sm text-gray-500">${signUpDate}</td>
          <td class="px-4 py-3 font-semibold">${calculationCount}</td>
          <td class="px-4 py-3 space-x-2">
            <button class="bg-purple-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-600 transition-colors duration-200 view-user-btn" data-id="${user.id}">হিস্টরি দেখুন</button>
            <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-600 transition-colors duration-200 delete-user-btn" data-id="${user.id}">মুছে ফেলুন</button>
          </td>
        `;
        usersListEl.appendChild(row);
      });
    }
    
    function renderActivityList(searchTerm = '') {
      activityListEl.innerHTML = '';
      const recentActivity = [...allHistoryData].sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).slice(0, 100);
      
      const filteredActivity = recentActivity.filter(activity => {
        const userEmail = usersData.find(u => u.id === activity.userId)?.email || '';
        return !searchTerm || 
        (activity.loverName && activity.loverName.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (activity.partnerName && activity.partnerName.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (userEmail && userEmail.toLowerCase().includes(searchTerm.toLowerCase()));
      });
      
      if (filteredActivity.length === 0) {
        activityListEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">কোন কার্যকলাপ পাওয়া যায়নি।</td></tr>`;
        return;
      }
      
      filteredActivity.forEach(activity => {
        const user = usersData.find(u => u.id === activity.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${activity.loverName || 'অজানা'} ❤️ ${activity.partnerName || 'অজানা'}`;
        const time = activity.timestamp?.toDate().toLocaleString('bn-BD') || 'অজানা';
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${userEmail}</td>
          <td class="px-4 py-3">${names}</td>
          <td class="px-4 py-3 font-semibold text-pink-600">${activity.percentage}%</td>
          <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
        `;
        activityListEl.appendChild(row);
      });
    }

    function renderHistoryList(userId = null, searchTerm = '') {
      historyListEl.innerHTML = '';
      let filteredHistory = allHistoryData;
      
      if (userId) {
        filteredHistory = allHistoryData.filter(h => h.userId === userId);
      }
      
      if (searchTerm) {
        const lowerCaseSearch = searchTerm.toLowerCase();
        filteredHistory = filteredHistory.filter(h => {
          const userEmail = usersData.find(u => u.id === h.userId)?.email || '';
          return (h.loverName && h.loverName.toLowerCase().includes(lowerCaseSearch)) ||
                 (h.partnerName && h.partnerName.toLowerCase().includes(lowerCaseSearch)) ||
                 (userEmail && userEmail.toLowerCase().includes(lowerCaseSearch));
        });
      }

      filteredHistory.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

      if (filteredHistory.length === 0) {
          historyListEl.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">কোন হিস্টরি পাওয়া যায়নি।</td></tr>`;
          return;
      }

      filteredHistory.forEach(historyItem => {
        const user = usersData.find(u => u.id === historyItem.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${historyItem.loverName || 'অজানা'} ❤️ ${historyItem.partnerName || 'অজানা'}`;
        const time = historyItem.timestamp?.toDate().toLocaleString('bn-BD') || 'অজানা';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${userEmail}</td>
          <td class="px-4 py-3">${names}</td>
          <td class="px-4 py-3 font-semibold text-pink-600">${historyItem.percentage}%</td>
          <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
          <td class="px-4 py-3">
            <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-600 transition-colors duration-200 delete-history-btn" data-id="${historyItem.id}" data-userid="${historyItem.userId}">মুছে ফেলুন</button>
          </td>
        `;
        historyListEl.appendChild(row);
      });
    }

    // --- UI Interaction ---
    function switchTab(tabId) {
      sidebarLinks.forEach(link => {
        link.classList.remove('active-link');
        if (link.dataset.tab === tabId) {
          link.classList.add('active-link');
          pageTitleEl.textContent = link.querySelector('span:last-child').textContent;
        }
      });
      tabContents.forEach(content => {
        content.classList.toggle('hidden', content.id !== `${tabId}-tab`);
      });
    }
    
    function showConfirmation(message, onConfirm) {
      modalText.textContent = message;
      confirmationModal.classList.remove('hidden');
      
      const confirmListener = () => {
        cleanup();
        onConfirm();
      };
      
      const cancelListener = () => {
        cleanup();
      };

      const cleanup = () => {
        confirmBtn.removeEventListener('click', confirmListener);
        cancelBtn.removeEventListener('click', cancelListener);
        confirmationModal.classList.add('hidden');
      };

      confirmBtn.addEventListener('click', confirmListener);
      cancelBtn.addEventListener('click', cancelListener);
    }

    // --- Event Listeners ---
    sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });
    
    // Search listeners
    searchUserBtn.addEventListener('click', () => renderUsersList(userSearchInput.value.trim()));
    userSearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && renderUsersList(userSearchInput.value.trim()));
    
    searchActivityBtn.addEventListener('click', () => renderActivityList(activitySearchInput.value.trim()));
    activitySearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && renderActivityList(activitySearchInput.value.trim()));
    
    searchHistoryBtn.addEventListener('click', () => renderHistoryList(null, historySearchInput.value.trim()));
    historySearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && renderHistoryList(null, historySearchInput.value.trim()));
    
    // Clear all history
    clearHistoryBtn.addEventListener('click', () => {
      showConfirmation('আপনি কি সমস্ত হিস্টরি মুছে ফেলতে চান? এই কাজটি আর ফিরিয়ে আনা যাবে না।', async () => {
        loadingModal.classList.remove('hidden');
        try {
          const historySnap = await getDocs(collectionGroup(db, 'history'));
          if (historySnap.empty) return;

          const batch = writeBatch(db);
          const userRefsToUpdate = new Set();
          
          historySnap.forEach(doc => {
              batch.delete(doc.ref);
              const path = doc.ref.path.split('/');
              const userId = path[path.indexOf('users') + 1];
              userRefsToUpdate.add(doc(db, `artifacts/${appId}/public/users/${userId}`));
          });
          
          userRefsToUpdate.forEach(userRef => {
              batch.update(userRef, { calculationCount: 0 });
          });

          await batch.commit();
          updateAllUI(); // Refresh UI after deletion
        } catch (error) {
          console.error("Error clearing all history:", error);
        } finally {
          loadingModal.classList.add('hidden');
        }
      });
    });

    // Dynamic event listener for table buttons
    document.body.addEventListener('click', async (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      // Delete user
      if (target.classList.contains('delete-user-btn')) {
        const userId = target.dataset.id;
        showConfirmation('আপনি কি এই ব্যবহারকারীকে এবং তার সমস্ত ডেটা মুছে ফেলতে চান?', async () => {
          loadingModal.classList.remove('hidden');
          try {
            const batch = writeBatch(db);
            const userRef = doc(db, `artifacts/${appId}/public/users/${userId}`);
            const historySnap = await getDocs(collection(userRef, 'history'));
            historySnap.forEach(doc => batch.delete(doc.ref));
            batch.delete(userRef);
            await batch.commit();
            updateAllUI();
          } catch (error) {
            console.error("Error deleting user:", error);
          } finally {
            loadingModal.classList.add('hidden');
          }
        });
      }
      // View user history
      if (target.classList.contains('view-user-btn')) {
        const userId = target.dataset.id;
        historySearchInput.value = '';
        renderHistoryList(userId);
        switchTab('history');
      }
      // Delete history item
      if (target.classList.contains('delete-history-btn')) {
        const historyId = target.dataset.id;
        const userId = target.dataset.userid;
        showConfirmation('আপনি কি এই হিস্টরি আইটেমটি মুছে ফেলতে চান?', async () => {
          loadingModal.classList.remove('hidden');
          try {
            const historyRef = doc(db, `artifacts/${appId}/public/users/${userId}/history/${historyId}`);
            await deleteDoc(historyRef);
            
            const userRef = doc(db, `artifacts/${appId}/public/users/${userId}`);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const currentCount = userDoc.data().calculationCount || 0;
                await updateDoc(userRef, { calculationCount: Math.max(0, currentCount - 1) });
            }
            updateAllUI();
          } catch (error) {
            console.error("Error deleting history item:", error);
          } finally {
            loadingModal.classList.add('hidden');
          }
        });
      }
    });

  </script>
</body>
</html>
