<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>লাভ ক্যালকুলেটর - অ্যাডমিন প্যানেল</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7',
              600: '#9333ea',
              700: '#7e22ce',
              800: '#6b21a8',
              900: '#581c87',
            },
            secondary: {
              50: '#fdf2f8',
              100: '#fce7f3',
              200: '#fbcfe8',
              300: '#f9a8d4',
              400: '#f472b6',
              500: '#ec4899',
              600: '#db2777',
              700: '#be185d',
              800: '#9d174d',
              900: '#831843',
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Poppins', 'Noto Sans Bengali', sans-serif;
      color: #1f2937;
    }
    .bg-gradient-admin {
      background: linear-gradient(135deg, #6b21a8 0%, #be185d 100%);
    }
    .sidebar-item {
      @apply flex items-center space-x-3 p-3 rounded-lg text-lg transition-all duration-200 hover:bg-primary-700 hover:pl-5;
    }
    .sidebar-item.active {
      @apply bg-secondary-600 pl-5;
    }
    .card {
      @apply bg-white rounded-2xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl;
    }
    .btn-primary {
      @apply px-6 py-3 bg-gradient-to-r from-primary-600 to-secondary-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all duration-300 shadow-lg;
    }
    .btn-danger {
      @apply px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all duration-300 shadow-lg;
    }
    .spinner {
      border-top-color: #a855f7;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-zoom-in {
      animation: zoomIn 0.3s ease-out;
    }
    @keyframes zoomIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <div id="login-container" class="bg-gradient-admin min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full animate-zoom-in">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-primary-600 to-secondary-600 bg-clip-text text-transparent">
          অ্যাডমিন প্যানেল
        </h1>
        <p class="text-gray-500 mt-2">আপনার অ্যাডমিন অ্যাকাউন্ট দিয়ে লগইন করুন</p>
      </div>
      
      <button id="google-login-btn" class="w-full flex items-center justify-center space-x-3 px-4 py-3 bg-white border border-gray-300 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition-all duration-300 shadow-sm">
        <svg class="w-6 h-6" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
        </svg>
        <span>গুগল দিয়ে লগইন করুন</span>
      </button>

      <div id="login-status" class="mt-6 text-center">
        <div id="login-spinner" class="w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full spinner mx-auto hidden"></div>
        <p id="login-message" class="text-sm mt-2"></p>
      </div>
    </div>
  </div>

  <div id="admin-panel" class="hidden min-h-screen">
    <aside class="w-64 bg-primary-800 text-white fixed h-screen z-50 transition-all duration-300">
      <div class="p-6 border-b border-primary-700 flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-secondary-500 flex items-center justify-center text-white font-bold">A</div>
        <div>
          <h2 class="text-xl font-bold">অ্যাডমিন প্যানেল</h2>
          <p id="admin-email-short" class="text-xs text-primary-200"></p>
        </div>
      </div>
      <nav class="flex-1 mt-4 px-4">
        <ul class="space-y-1">
          <li>
            <a href="#" data-tab="dashboard" class="sidebar-item active">
              <span class="material-icons-round">dashboard</span>
              <span>ড্যাশবোর্ড</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="users" class="sidebar-item">
              <span class="material-icons-round">people</span>
              <span>ব্যবহারকারী</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="activity" class="sidebar-item">
              <span class="material-icons-round">history</span>
              <span>কার্যকলাপ</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="history" class="sidebar-item">
              <span class="material-icons-round">list_alt</span>
              <span>সমস্ত হিস্টরি</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="settings" class="sidebar-item">
              <span class="material-icons-round">settings</span>
              <span>সেটিংস</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="p-4 border-t border-primary-700">
        <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 p-3 bg-secondary-600 rounded-xl text-lg font-medium hover:bg-secondary-700 transition-all duration-300">
          <span class="material-icons-round">logout</span>
          <span>লগআউট</span>
        </button>
      </div>
    </aside>

    <main class="ml-64 p-6 min-h-screen bg-gray-50 transition-all duration-300">
      <header class="flex justify-between items-center mb-8">
        <div>
          <h1 id="page-title" class="text-3xl font-bold text-gray-800">ড্যাশবোর্ড</h1>
          <p class="text-gray-500 text-sm">সাম্প্রতিক কার্যকলাপ ও পরিসংখ্যান</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right hidden md:block">
            <p id="admin-name" class="font-medium text-gray-700"></p>
            <p id="admin-email" class="text-sm text-gray-500"></p>
          </div>
          <img id="admin-photo" src="https://ui-avatars.com/api/?name=A&background=7e22ce&color=fff" alt="Admin" class="w-12 h-12 rounded-full border-2 border-white shadow-md">
        </div>
      </header>

      <div id="main-loading-spinner" class="flex justify-center items-center h-[50vh] hidden">
        <div class="w-16 h-16 border-4 border-gray-200 border-t-primary-500 rounded-full spinner"></div>
      </div>
      
      <div id="dashboard-tab" class="tab-content animate-fade-in">
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="card hover:border-primary-500 border border-transparent">
            <div class="text-gray-500 text-sm font-medium">মোট ব্যবহারকারী</div>
            <div id="total-users" class="text-4xl font-bold mt-2 text-primary-600">0</div>
            <div class="mt-2 text-sm text-gray-500 flex items-center">
              <span class="material-icons-round text-green-500 text-base">trending_up</span>
              <span class="ml-1">গত ৭ দিনে +12%</span>
            </div>
          </div>
          <div class="card hover:border-primary-500 border border-transparent">
            <div class="text-gray-500 text-sm font-medium">মোট গণনা</div>
            <div id="total-calculations" class="text-4xl font-bold mt-2 text-primary-600">0</div>
            <div class="mt-2 text-sm text-gray-500 flex items-center">
              <span class="material-icons-round text-green-500 text-base">trending_up</span>
              <span class="ml-1">গত ৭ দিনে +24%</span>
            </div>
          </div>
          <div class="card hover:border-primary-500 border border-transparent">
            <div class="text-gray-500 text-sm font-medium">আজকের কার্যকলাপ</div>
            <div id="today-activity" class="text-4xl font-bold mt-2 text-primary-600">0</div>
            <div class="mt-2 text-sm text-gray-500 flex items-center">
              <span class="material-icons-round text-green-500 text-base">trending_up</span>
              <span class="ml-1">গতকালের তুলনায় +5%</span>
            </div>
          </div>
          <div class="card hover:border-primary-500 border border-transparent">
            <div class="text-gray-500 text-sm font-medium">গড় প্রেম শতাংশ</div>
            <div id="avg-percentage" class="text-4xl font-bold mt-2 text-primary-600">0%</div>
            <div class="mt-2 text-sm text-gray-500">
              সর্বোচ্চ: <span id="max-percentage" class="font-medium">0%</span>
            </div>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mb-8">
          <div class="card">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold text-gray-800">সাম্প্রতিক গণনা</h2>
              <button id="refresh-calculations" class="text-primary-600 hover:text-primary-800 transition-colors">
                <span class="material-icons-round">refresh</span>
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="text-left border-b border-gray-200">
                    <th class="pb-2 text-gray-500 font-medium">ব্যবহারকারী</th>
                    <th class="pb-2 text-gray-500 font-medium">নাম</th>
                    <th class="pb-2 text-gray-500 font-medium">শতাংশ</th>
                    <th class="pb-2 text-gray-500 font-medium">সময়</th>
                  </tr>
                </thead>
                <tbody id="latest-calculations" class="divide-y divide-gray-200"></tbody>
              </table>
              <div id="no-calculations" class="py-8 text-center text-gray-500 hidden">
                <span class="material-icons-round text-4xl text-gray-300 mb-2">inbox</span>
                <p>কোন গণনা পাওয়া যায়নি</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">শীর্ষ ব্যবহারকারী</h2>
            <div class="space-y-4">
              <div id="top-users" class="space-y-3">
                </div>
              <div id="no-top-users" class="py-8 text-center text-gray-500 hidden">
                <span class="material-icons-round text-4xl text-gray-300 mb-2">group</span>
                <p>কোন ব্যবহারকারী পাওয়া যায়নি</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="users-tab" class="tab-content hidden animate-fade-in">
        <div class="card mb-6">
          <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="flex-1 relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 material-icons-round text-gray-400">search</span>
              <input type="text" id="user-search" placeholder="ব্যবহারকারী অনুসন্ধান করুন..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300">
            </div>
            <button id="search-user-btn" class="btn-primary">
              <span class="material-icons-round mr-2">search</span>
              অনুসন্ধান
            </button>
          </div>
        </div>

        <div class="card">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="text-left border-b border-gray-200">
                  <th class="pb-2 text-gray-500 font-medium">ইমেইল</th>
                  <th class="pb-2 text-gray-500 font-medium">সাইন আপ তারিখ</th>
                  <th class="pb-2 text-gray-500 font-medium">গণনা</th>
                  <th class="pb-2 text-gray-500 font-medium">শেষ কার্যকলাপ</th>
                  <th class="pb-2 text-gray-500 font-medium">অ্যাকশন</th>
                </tr>
              </thead>
              <tbody id="users-list" class="divide-y divide-gray-200"></tbody>
            </table>
            <div id="no-users" class="py-8 text-center text-gray-500 hidden">
              <span class="material-icons-round text-4xl text-gray-300 mb-2">group_off</span>
              <p>কোন ব্যবহারকারী পাওয়া যায়নি</p>
            </div>
          </div>
        </div>
      </div>
      
      <div id="activity-tab" class="tab-content hidden animate-fade-in">
        <div class="card mb-6">
          <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="flex-1 relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 material-icons-round text-gray-400">search</span>
              <input type="text" id="activity-search" placeholder="কার্যকলাপ অনুসন্ধান করুন..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300">
            </div>
            <div class="flex space-x-2">
              <select id="activity-filter" class="px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300">
                <option value="all">সমস্ত কার্যকলাপ</option>
                <option value="today">আজ</option>
                <option value="week">এই সপ্তাহ</option>
                <option value="month">এই মাস</option>
              </select>
              <button id="search-activity-btn" class="btn-primary">
                <span class="material-icons-round mr-2">search</span>
                অনুসন্ধান
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="text-left border-b border-gray-200">
                  <th class="pb-2 text-gray-500 font-medium">ব্যবহারকারী</th>
                  <th class="pb-2 text-gray-500 font-medium">নাম</th>
                  <th class="pb-2 text-gray-500 font-medium">শতাংশ</th>
                  <th class="pb-2 text-gray-500 font-medium">সময়</th>
                </tr>
              </thead>
              <tbody id="activity-list" class="divide-y divide-gray-200"></tbody>
            </table>
            <div id="no-activity" class="py-8 text-center text-gray-500 hidden">
              <span class="material-icons-round text-4xl text-gray-300 mb-2">hourglass_empty</span>
              <p>কোন কার্যকলাপ পাওয়া যায়নি</p>
            </div>
          </div>
        </div>
      </div>
      
      <div id="history-tab" class="tab-content hidden animate-fade-in">
        <div class="card mb-6">
          <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="flex-1 relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 material-icons-round text-gray-400">search</span>
              <input type="text" id="history-search" placeholder="হিস্টরি অনুসন্ধান করুন..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300">
            </div>
            <div class="flex space-x-2">
              <button id="search-history-btn" class="btn-primary">
                <span class="material-icons-round mr-2">search</span>
                অনুসন্ধান
              </button>
              <button id="clear-history-btn" class="btn-danger">
                <span class="material-icons-round mr-2">delete_forever</span>
                সব মুছুন
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="text-left border-b border-gray-200">
                  <th class="pb-2 text-gray-500 font-medium">ব্যবহারকারী</th>
                  <th class="pb-2 text-gray-500 font-medium">নাম</th>
                  <th class="pb-2 text-gray-500 font-medium">শতাংশ</th>
                  <th class="pb-2 text-gray-500 font-medium">সময়</th>
                  <th class="pb-2 text-gray-500 font-medium">অ্যাকশন</th>
                </tr>
              </thead>
              <tbody id="history-list" class="divide-y divide-gray-200"></tbody>
            </table>
            <div id="no-history" class="py-8 text-center text-gray-500 hidden">
              <span class="material-icons-round text-4xl text-gray-300 mb-2">history</span>
              <p>কোন হিস্টরি পাওয়া যায়নি</p>
            </div>
          </div>
        </div>
      </div>

      <div id="settings-tab" class="tab-content hidden animate-fade-in">
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">অ্যাডমিন সেটিংস</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-gray-700 mb-2">অ্যাডমিন ইমেইল</label>
                <input type="email" id="admin-email-input" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300" disabled>
              </div>
              <div>
                <label class="block text-gray-700 mb-2">অ্যাপ আইডি</label>
                <input type="text" id="app-id-input" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300" disabled>
              </div>
              <button id="save-settings-btn" class="btn-primary w-full">
                <span class="material-icons-round mr-2">save</span>
                সেটিংস সংরক্ষণ করুন
              </button>
            </div>
          </div>

          <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">সিস্টেম তথ্য</h2>
            <div class="space-y-4">
              <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                <span class="text-gray-600">অ্যাপ সংস্করণ</span>
                <span id="app-version" class="font-medium">1.0.0</span>
              </div>
              <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                <span class="text-gray-600">Firebase সংস্করণ</span>
                <span id="firebase-version" class="font-medium">10.7.1</span>
              </div>
              <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                <span class="text-gray-600">সর্বশেষ আপডেট</span>
                <span id="last-updated" class="font-medium">আজ, 12:30 PM</span>
              </div>
              <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                <span class="text-gray-600">ডাটাবেস সাইজ</span>
                <span id="db-size" class="font-medium">2.4 MB</span>
              </div>
              <div class="pt-4">
                <button id="refresh-data-btn" class="btn-primary w-full">
                  <span class="material-icons-round mr-2">refresh</span>
                  সমস্ত ডেটা রিফ্রেশ করুন
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full animate-zoom-in">
      <div class="flex items-center space-x-3 mb-4">
        <span class="material-icons-round text-red-500 text-3xl">warning</span>
        <h3 class="text-xl font-bold text-gray-800">আপনি কি নিশ্চিত?</h3>
      </div>
      <p id="modal-text" class="text-gray-600 mb-6">এই কাজটি করা হলে তা আর পূর্বাবস্থায় ফেরানো যাবে না। আপনি কি নিশ্চিতভাবে এই কাজটি করতে চান?</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors duration-200">
          বাতিল
        </button>
        <button id="confirm-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors duration-200">
          নিশ্চিত করুন
        </button>
      </div>
    </div>
  </div>
  
  <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-6 max-w-xs w-full text-center animate-zoom-in">
      <div class="w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full spinner mx-auto"></div>
      <p class="mt-4 text-gray-700 font-medium" id="loading-text">প্রক্রিয়াকরণ হচ্ছে...</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut, 
      GoogleAuthProvider, 
      signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      getDoc, 
      getDocs, 
      query, 
      where, 
      orderBy, 
      limit, 
      deleteDoc, 
      writeBatch, 
      collectionGroup,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCTvWKR6pt8HrHoiDHo3wqoSXtXdXJjHHQ",
      authDomain: "priya-ai-q14sj.firebaseapp.com",
      projectId: "priya-ai-q14sj",
      storageBucket: "priya-ai-q14sj.appspot.com",
      messagingSenderId: "113852032496",
      appId: "1:113852032496:web:a6156f264323f54d9ae935"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();
    const appId = "love-calculator-bd"; // Your custom app ID

    // DOM Elements
    const loginContainer = document.getElementById('login-container');
    const adminPanel = document.getElementById('admin-panel');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const loginSpinner = document.getElementById('login-spinner');
    const loginMessage = document.getElementById('login-message');
    const logoutBtn = document.getElementById('logout-btn');
    const adminPhoto = document.getElementById('admin-photo');
    const adminName = document.getElementById('admin-name');
    const adminEmail = document.getElementById('admin-email');
    const adminEmailShort = document.getElementById('admin-email-short');
    const pageTitleEl = document.getElementById('page-title');
    const mainLoadingSpinner = document.getElementById('main-loading-spinner');
    const sidebarLinks = document.querySelectorAll('.sidebar-item');
    const tabContents = document.querySelectorAll('.tab-content');

    // Dashboard Elements
    const totalUsersEl = document.getElementById('total-users');
    const totalCalculationsEl = document.getElementById('total-calculations');
    const todayActivityEl = document.getElementById('today-activity');
    const avgPercentageEl = document.getElementById('avg-percentage');
    const maxPercentageEl = document.getElementById('max-percentage');
    const latestCalculationsEl = document.getElementById('latest-calculations');
    const noCalculationsEl = document.getElementById('no-calculations');
    const topUsersEl = document.getElementById('top-users');
    const noTopUsersEl = document.getElementById('no-top-users');
    const refreshCalculationsBtn = document.getElementById('refresh-calculations');

    // Users Tab Elements
    const userSearchInput = document.getElementById('user-search');
    const searchUserBtn = document.getElementById('search-user-btn');
    const usersListEl = document.getElementById('users-list');
    const noUsersEl = document.getElementById('no-users');

    // Activity Tab Elements
    const activitySearchInput = document.getElementById('activity-search');
    const activityFilter = document.getElementById('activity-filter');
    const searchActivityBtn = document.getElementById('search-activity-btn');
    const activityListEl = document.getElementById('activity-list');
    const noActivityEl = document.getElementById('no-activity');

    // History Tab Elements
    const historySearchInput = document.getElementById('history-search');
    const searchHistoryBtn = document.getElementById('search-history-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const historyListEl = document.getElementById('history-list');
    const noHistoryEl = document.getElementById('no-history');

    // Settings Tab Elements
    const adminEmailInput = document.getElementById('admin-email-input');
    const appIdInput = document.getElementById('app-id-input');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const refreshDataBtn = document.getElementById('refresh-data-btn');

    // Modal Elements
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalText = document.getElementById('modal-text');
    const confirmBtn = document.getElementById('confirm-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const loadingModal = document.getElementById('loading-modal');
    const loadingText = document.getElementById('loading-text');

    // Global Variables
    let currentAdmin = null;
    let usersData = [];
    let allHistoryData = [];
    let isInitialDataLoaded = false;
    const ADMIN_EMAILS = ["smartwork19999@gmail.com", "another_admin@gmail.com"]; // Multiple admin support

    // Helper Functions
    function formatDate(date) {
      if (!date) return 'অজানা';
      const options = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return date.toLocaleDateString('bn-BD', options);
    }

    function showLoginMessage(message, isError = false) {
      loginMessage.textContent = message;
      loginMessage.className = isError ? 'text-red-600' : 'text-gray-600';
    }

    function toggleLoginSpinner(show) {
      loginSpinner.classList.toggle('hidden', !show);
    }

    function showAdminPanel(show) {
      loginContainer.classList.toggle('hidden', show);
      adminPanel.classList.toggle('hidden', !show);
    }

    function showLoading(show, text = 'প্রক্রিয়াকরণ হচ্ছে...') {
      if (show) {
        loadingText.textContent = text;
        loadingModal.classList.remove('hidden');
      } else {
        loadingModal.classList.add('hidden');
      }
    }

    function showConfirmation(message, onConfirm) {
      modalText.textContent = message;
      confirmationModal.classList.remove('hidden');
      
      const confirmHandler = () => {
        cleanup();
        onConfirm();
      };
      
      const cancelHandler = () => {
        cleanup();
      };

      const cleanup = () => {
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
        confirmationModal.classList.add('hidden');
      };

      confirmBtn.addEventListener('click', confirmHandler);
      cancelBtn.addEventListener('click', cancelHandler);
    }

    function switchTab(tabId) {
      sidebarLinks.forEach(link => {
        link.classList.remove('active');
        if (link.dataset.tab === tabId) {
          link.classList.add('active');
          pageTitleEl.textContent = link.querySelector('span:last-child').textContent;
        }
      });
      
      tabContents.forEach(content => {
        content.classList.toggle('hidden', content.id !== `${tabId}-tab`);
      });
    }

    // Data Loading Functions
    async function loadInitialData() {
      mainLoadingSpinner.classList.remove('hidden');
      
      try {
        // Load users data
        const usersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/users`));
        usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Load history data
        // Use a limit to prevent performance issues with large datasets
        const historyQuery = query(collectionGroup(db, 'history'), orderBy('timestamp', 'desc'), limit(500));
        const historySnapshot = await getDocs(historyQuery);
        allHistoryData = historySnapshot.docs.map(doc => {
          const path = doc.ref.path.split('/');
          const userId = path[path.indexOf('users') + 1];
          return { 
            id: doc.id, 
            userId: userId, 
            ...doc.data(),
            timestamp: doc.data().timestamp?.toDate() 
          };
        });
        
        updateAllUI();
      } catch (error) {
        console.error("Error loading initial data:", error);
      } finally {
        mainLoadingSpinner.classList.add('hidden');
        isInitialDataLoaded = true;
      }
    }

    function updateAllUI() {
      updateDashboard();
      renderUsersList();
      renderActivityList();
      renderHistoryList();
      updateTopUsers();
    }

    function updateDashboard() {
      // Update stats
      totalUsersEl.textContent = usersData.length.toLocaleString('bn-BD');
      totalCalculationsEl.textContent = allHistoryData.length.toLocaleString('bn-BD');
      
      // Today's activity
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayActivityCount = allHistoryData.filter(h => h.timestamp >= today).length;
      todayActivityEl.textContent = todayActivityCount.toLocaleString('bn-BD');
      
      // Average and max percentage
      const percentages = allHistoryData.map(h => h.percentage || 0);
      const totalPercentage = percentages.reduce((sum, p) => sum + p, 0);
      const avgPercentage = allHistoryData.length > 0 ? (totalPercentage / allHistoryData.length).toFixed(2) : 0;
      const maxPercentage = allHistoryData.length > 0 ? Math.max(...percentages) : 0;
      
      avgPercentageEl.textContent = `${avgPercentage}%`;
      maxPercentageEl.textContent = `${maxPercentage}%`;
      
      renderLatestCalculations();
    }

    function renderLatestCalculations() {
      latestCalculationsEl.innerHTML = '';
      const latest = [...allHistoryData]
        .sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0))
        .slice(0, 5);
      
      if (latest.length === 0) {
        noCalculationsEl.classList.remove('hidden');
        return;
      }
      
      noCalculationsEl.classList.add('hidden');
      
      latest.forEach(calc => {
        const user = usersData.find(u => u.id === calc.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${calc.loverName || 'অজানা'} ❤️ ${calc.partnerName || 'অজানা'}`;
        const time = formatDate(calc.timestamp);
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        row.innerHTML = `
          <td class="py-3 text-sm">${userEmail}</td>
          <td class="py-3">${names}</td>
          <td class="py-3 font-semibold text-secondary-600">${calc.percentage}%</td>
          <td class="py-3 text-sm text-gray-500">${time}</td>
        `;
        latestCalculationsEl.appendChild(row);
      });
    }

    function updateTopUsers() {
      topUsersEl.innerHTML = '';
      
      // Get top 5 users by calculation count
      const usersWithCount = usersData.map(user => {
        const count = allHistoryData.filter(h => h.userId === user.id).length;
        return { ...user, count };
      }).filter(user => user.count > 0)
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);
      
      if (usersWithCount.length === 0) {
        noTopUsersEl.classList.remove('hidden');
        return;
      }
      
      noTopUsersEl.classList.add('hidden');
      
      usersWithCount.forEach((user, index) => {
        const userEl = document.createElement('div');
        userEl.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        userEl.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full bg-primary-100 text-primary-800 flex items-center justify-center font-bold">
              ${index + 1}
            </div>
            <div>
              <p class="font-medium">${user.email || 'অজানা'}</p>
              <p class="text-xs text-gray-500">${user.signUpDate ? formatDate(user.signUpDate.toDate()) : 'অজানা তারিখ'}</p>
            </div>
          </div>
          <div class="bg-primary-100 text-primary-800 px-3 py-1 rounded-full text-sm font-medium">
            ${user.count} গণনা
          </div>
        `;
        topUsersEl.appendChild(userEl);
      });
    }

    function renderUsersList(searchTerm = '') {
      usersListEl.innerHTML = '';
      
      // Corrected logical error: sort after filter
      let filteredUsers = usersData.filter(user => 
        !searchTerm || 
        (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      filteredUsers.sort((a, b) => (b.signUpDate?.toDate()?.getTime() || 0) - (a.signUpDate?.toDate()?.getTime() || 0));
      
      if (filteredUsers.length === 0) {
        noUsersEl.classList.remove('hidden');
        return;
      }
      
      noUsersEl.classList.add('hidden');
      
      filteredUsers.forEach(user => {
        const calculationCount = allHistoryData.filter(h => h.userId === user.id).length;
        const lastActivity = allHistoryData
          .filter(h => h.userId === user.id)
          .sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0))[0];
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        row.innerHTML = `
          <td class="py-3">
            <p class="font-medium">${user.email || 'অজানা'}</p>
            <p class="text-xs text-gray-500">${user.id}</p>
          </td>
          <td class="py-3 text-sm text-gray-500">${user.signUpDate ? formatDate(user.signUpDate.toDate()) : 'অজানা'}</td>
          <td class="py-3 font-medium">${calculationCount}</td>
          <td class="py-3 text-sm text-gray-500">${lastActivity ? formatDate(lastActivity.timestamp) : 'কোন কার্যকলাপ নেই'}</td>
          <td class="py-3 space-x-2">
            <button class="px-3 py-1 bg-primary-100 text-primary-800 rounded-lg text-sm font-medium hover:bg-primary-200 transition-colors view-user-btn" data-id="${user.id}">
              দেখুন
            </button>
            <button class="px-3 py-1 bg-red-100 text-red-800 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors delete-user-btn" data-id="${user.id}">
              মুছুন
            </button>
          </td>
        `;
        usersListEl.appendChild(row);
      });
    }

    function renderActivityList(searchTerm = '', filter = 'all') {
      activityListEl.innerHTML = '';
      
      let filteredActivity = [...allHistoryData];
      
      // Apply time filter
      const now = new Date();
      switch (filter) {
        case 'today':
          const today = new Date(now);
          today.setHours(0, 0, 0, 0);
          filteredActivity = filteredActivity.filter(a => a.timestamp >= today);
          break;
        case 'week':
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          filteredActivity = filteredActivity.filter(a => a.timestamp >= weekAgo);
          break;
        case 'month':
          const monthAgo = new Date(now);
          monthAgo.setMonth(monthAgo.getMonth() - 1);
          filteredActivity = filteredActivity.filter(a => a.timestamp >= monthAgo);
          break;
      }
      
      // Apply search term
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredActivity = filteredActivity.filter(activity => {
          const user = usersData.find(u => u.id === activity.userId);
          const userEmail = user?.email || '';
          return (
            (activity.loverName && activity.loverName.toLowerCase().includes(term)) ||
            (activity.partnerName && activity.partnerName.toLowerCase().includes(term)) ||
            (userEmail && userEmail.toLowerCase().includes(term))
          );
        });
      }
      
      filteredActivity.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
      
      if (filteredActivity.length === 0) {
        noActivityEl.classList.remove('hidden');
        return;
      }
      
      noActivityEl.classList.add('hidden');
      
      filteredActivity.slice(0, 100).forEach(activity => {
        const user = usersData.find(u => u.id === activity.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${activity.loverName || 'অজানা'} ❤️ ${activity.partnerName || 'অজানা'}`;
        const time = formatDate(activity.timestamp);
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        row.innerHTML = `
          <td class="py-3">${userEmail}</td>
          <td class="py-3">${names}</td>
          <td class="py-3 font-semibold text-secondary-600">${activity.percentage}%</td>
          <td class="py-3 text-sm text-gray-500">${time}</td>
        `;
        activityListEl.appendChild(row);
      });
    }

    function renderHistoryList(userId = null, searchTerm = '') {
      historyListEl.innerHTML = '';
      
      let filteredHistory = [...allHistoryData];
      
      if (userId) {
        filteredHistory = filteredHistory.filter(h => h.userId === userId);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredHistory = filteredHistory.filter(h => {
          const user = usersData.find(u => u.id === h.userId);
          const userEmail = user?.email || '';
          return (
            (h.loverName && h.loverName.toLowerCase().includes(term)) ||
            (h.partnerName && h.partnerName.toLowerCase().includes(term)) ||
            (userEmail && userEmail.toLowerCase().includes(term))
          );
        });
      }
      
      filteredHistory.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
      
      if (filteredHistory.length === 0) {
        noHistoryEl.classList.remove('hidden');
        return;
      }
      
      noHistoryEl.classList.add('hidden');
      
      filteredHistory.forEach(historyItem => {
        const user = usersData.find(u => u.id === historyItem.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${historyItem.loverName || 'অজানা'} ❤️ ${historyItem.partnerName || 'অজানা'}`;
        const time = formatDate(historyItem.timestamp);
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        row.innerHTML = `
          <td class="py-3">${userEmail}</td>
          <td class="py-3">${names}</td>
          <td class="py-3 font-semibold text-secondary-600">${historyItem.percentage}%</td>
          <td class="py-3 text-sm text-gray-500">${time}</td>
          <td class="py-3">
            <button class="px-3 py-1 bg-red-100 text-red-800 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors delete-history-btn" data-id="${historyItem.id}" data-userid="${historyItem.userId}">
              মুছুন
            </button>
          </td>
        `;
        historyListEl.appendChild(row);
      });
    }

    // Event Listeners
    googleLoginBtn.addEventListener('click', async () => {
      toggleLoginSpinner(true);
      showLoginMessage('গুগল অ্যাকাউন্ট দিয়ে লগইন করা হচ্ছে...');
      
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (error) {
        console.error("Google Sign-In Error:", error);
        toggleLoginSpinner(false);
        showLoginMessage(`লগইন ব্যর্থ হয়েছে: ${error.code} - ${error.message}`, true);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      showLoading(true, 'লগআউট হচ্ছে...');
      try {
        await signOut(auth);
      } catch (error) {
        console.error("Logout failed:", error);
      } finally {
        showLoading(false);
      }
    });

    refreshCalculationsBtn.addEventListener('click', () => {
      renderLatestCalculations();
    });

    // Search functionality
    searchUserBtn.addEventListener('click', () => {
      renderUsersList(userSearchInput.value.trim());
    });

    userSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderUsersList(userSearchInput.value.trim());
    });

    searchActivityBtn.addEventListener('click', () => {
      renderActivityList(activitySearchInput.value.trim(), activityFilter.value);
    });

    activitySearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderActivityList(activitySearchInput.value.trim(), activityFilter.value);
    });

    searchHistoryBtn.addEventListener('click', () => {
      renderHistoryList(null, historySearchInput.value.trim());
    });

    historySearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderHistoryList(null, historySearchInput.value.trim());
    });

    // Clear all history
    clearHistoryBtn.addEventListener('click', () => {
      showConfirmation('আপনি কি সমস্ত হিস্টরি ডেটা মুছে ফেলতে চান? এই কাজটি অপরিবর্তনীয়।', async () => {
        showLoading(true, 'হিস্টরি মুছে ফেলা হচ্ছে...');
        try {
          const historySnap = await getDocs(collectionGroup(db, 'history'));
          if (!historySnap.empty) {
            const batch = writeBatch(db);
            historySnap.forEach(doc => {
              batch.delete(doc.ref);
            });
            await batch.commit();
          }
          
          // Refresh data
          await loadInitialData();
        } catch (error) {
          console.error("Error clearing history:", error);
          alert('হিস্টরি মোছার সময় একটি ত্রুটি হয়েছে।');
        } finally {
          showLoading(false);
        }
      });
    });

    // Tab switching
    sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });

    // Dynamic button handlers
    document.addEventListener('click', async (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      // Delete user
      if (target.classList.contains('delete-user-btn')) {
        const userId = target.dataset.id;
        const user = usersData.find(u => u.id === userId);
        
        showConfirmation(`আপনি কি "${user?.email || 'এই ব্যবহারকারী'}" কে এবং তার সমস্ত ডেটা মুছে ফেলতে চান?`, async () => {
          showLoading(true, 'ব্যবহারকারী মুছে ফেলা হচ্ছে...');
          try {
            // Delete user's history first
            const historySnap = await getDocs(collection(db, `artifacts/${appId}/public/users/${userId}/history`));
            const batch = writeBatch(db);
            
            historySnap.forEach(doc => {
              batch.delete(doc.ref);
            });
            
            // Delete user document
            batch.delete(doc(db, `artifacts/${appId}/public/users/${userId}`));
            
            await batch.commit();
            
            // Refresh data
            await loadInitialData();
          } catch (error) {
            console.error("Error deleting user:", error);
            alert('ব্যবহারকারী মোছার সময় একটি ত্রুটি হয়েছে।');
          } finally {
            showLoading(false);
          }
        });
      }
      
      // View user history
      if (target.classList.contains('view-user-btn')) {
        const userId = target.dataset.id;
        historySearchInput.value = '';
        renderHistoryList(userId);
        switchTab('history');
      }
      
      // Delete history item
      if (target.classList.contains('delete-history-btn')) {
        const historyId = target.dataset.id;
        const userId = target.dataset.userid;
        
        showConfirmation('আপনি কি এই হিস্টরি আইটেমটি মুছে ফেলতে চান?', async () => {
          showLoading(true, 'হিস্টরি মুছে ফেলা হচ্ছে...');
          try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/users/${userId}/history/${historyId}`));
            
            // Update user's calculation count
            const userRef = doc(db, `artifacts/${appId}/public/users/${userId}`);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists()) {
              const currentCount = userDoc.data().calculationCount || 0;
              await updateDoc(userRef, {
                calculationCount: Math.max(0, currentCount - 1)
              });
            }
            
            // Refresh data
            await loadInitialData();
          } catch (error) {
            console.error("Error deleting history item:", error);
            alert('হিস্টরি আইটেম মোছার সময় একটি ত্রুটি হয়েছে।');
          } finally {
            showLoading(false);
          }
        });
      }
    });

    // Settings
    refreshDataBtn.addEventListener('click', async () => {
      showLoading(true, 'ডেটা রিফ্রেশ করা হচ্ছে...');
      try {
        await loadInitialData();
      } catch (error) {
        console.error("Error refreshing data:", error);
      } finally {
        showLoading(false);
      }
    });

    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Check if user is an admin
        if (ADMIN_EMAILS.includes(user.email)) {
          currentAdmin = user;
          
          // Update admin info in UI
          adminPhoto.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email[0]}&background=7e22ce&color=fff`;
          adminName.textContent = user.displayName || 'অ্যাডমিন';
          adminEmail.textContent = user.email;
          adminEmailShort.textContent = user.email;
          
          showAdminPanel(true);
          if (!isInitialDataLoaded) {
            await loadInitialData();
          }
          
          // Set default tab
          switchTab('dashboard');
          showLoginMessage('');
        } else {
          // Not an admin, sign out
          showLoginMessage('আপনার অ্যাডমিন অ্যাক্সেস নেই।', true);
          await signOut(auth);
        }
      } else {
        // User signed out
        currentAdmin = null;
        showAdminPanel(false);
        isInitialDataLoaded = false;
        toggleLoginSpinner(false);
        showLoginMessage('');
      }
    });

    // Initialize settings tab
    adminEmailInput.value = ADMIN_EMAILS.join(', ');
    appIdInput.value = appId;
  </script>
</body>
          </html>
