<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>লাভ ক্যালকুলেটর - অ্যাডমিন প্যানেল</title>
  <!-- Tailwind CSS and custom fonts for modern design -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  
  <style>
    body {
      font-family: 'Poppins', 'Noto Sans Bengali', sans-serif;
      color: #333;
    }
    .bg-gradient-love {
      background-image: linear-gradient(to right, #6b21a8, #88138d, #be185d);
    }
    .input-field {
      @apply w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm;
    }
    .btn-primary {
      @apply w-full px-6 py-3 bg-pink-600 text-white font-semibold rounded-xl hover:bg-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg;
    }
    .btn-google {
      @apply w-full flex items-center justify-center space-x-2 px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl border border-gray-300 hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-md;
    }
    .bg-sidebar {
      background-color: #6a1b9a;
    }
    .hover\:bg-sidebar-light:hover {
      background-color: #7b1fa2;
    }
    .active-link {
      background-color: #f06292;
      border-left: 4px solid #d81b60;
    }
    .text-shadow {
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .spinner {
      border-top-color: #f06292;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      animation: zoomIn 0.3s ease-out;
    }
    @keyframes zoomIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tab-content, .login-container {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Admin Login Page -->
  <div id="login-container" class="bg-gradient-love min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full transition-transform transform hover:scale-105 duration-500">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-purple-800">অ্যাডমিন লগইন</h1>
        <p class="text-gray-500 mt-2">অ্যাডমিন প্যানেলে প্রবেশ করতে লগইন করুন।</p>
      </div>
      <div id="login-form">
        <!-- Google Login Button -->
        <button type="button" id="google-login-btn" class="btn-google mb-4">
          <svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M44.5 20H24V28.8H35.2C34.6 32.4 32.1 35.2 28.5 37.1V44H36.3C40.9 40.5 44 34.3 44 26.5C44 24.9 43.8 23.3 43.5 21.8C44.5 21.2 45.2 20.6 44.5 20Z" fill="#4285F4"/>
            <path d="M24 48C30.4 48 35.8 45.9 39.8 42.6L32 36.3C29.6 37.9 26.9 38.8 24 38.8C18 38.8 12.8 34.8 10.9 29.3L3.1 35.6C5.5 41.5 14.1 48 24 48Z" fill="#34A853"/>
            <path d="M10.9 29.3C10.5 28.1 10.3 26.8 10.3 25.4C10.3 24.1 10.5 22.8 10.9 21.6L3.1 15.3C3.1 16.9 3 18.7 3 20.6C3 29.5 9.4 37 18.2 41L26.1 34.7C24.2 33.6 22.9 32.2 21.9 30.6L10.9 29.3Z" fill="#FBBC04"/>
            <path d="M24 9.2C27.3 9.2 30.2 10.4 32.5 12.6L39.8 5.3C35.8 2 30.4 0 24 0C14.1 0 5.5 6.5 3.1 12.4L10.9 18.7C12.8 13.2 18 9.2 24 9.2Z" fill="#EA4335"/>
          </svg>
          <span>Google দিয়ে লগইন করুন</span>
        </button>
        <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative hidden mb-4" role="alert">
          <span id="error-text" class="block sm:inline"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-sidebar text-white shadow-xl flex flex-col fixed h-screen z-50">
      <div class="p-6 border-b border-purple-800 text-center">
        <h2 class="text-3xl font-bold text-pink-200">অ্যাডমিন</h2>
      </div>
      <nav class="flex-1 mt-4">
        <ul class="space-y-2 px-4">
          <li>
            <a href="#" data-tab="dashboard" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">dashboard</span>
              <span>ড্যাশবোর্ড</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="users" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">people</span>
              <span>ব্যবহারকারীগণ</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="activity" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">history</span>
              <span>সাম্প্রতিক কার্যকলাপ</span>
            </a>
          </li>
          <li>
            <a href="#" data-tab="history" class="flex items-center space-x-3 p-3 rounded-lg text-lg hover:bg-sidebar-light transition-colors duration-200">
              <span class="material-icons">list_alt</span>
              <span>সকল হিস্টরি</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="p-4 border-t border-purple-800">
        <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 p-3 bg-pink-500 rounded-xl text-lg font-semibold hover:bg-pink-600 transition-all duration-300 transform hover:scale-105">
          <span class="material-icons">logout</span>
          <span>লগআউট</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-64 p-8 transition-all duration-300">
      <header class="flex justify-between items-center pb-6 border-b border-gray-300 mb-8">
        <h1 id="page-title" class="text-4xl font-bold text-purple-800 text-shadow">ড্যাশবোর্ড</h1>
        <div class="flex items-center space-x-4">
          <img id="admin-photo" src="https://placehold.co/40x40/6a1b9a/ffffff?text=A" alt="Admin" class="w-12 h-12 rounded-full border-2 border-purple-600 shadow-md">
          <span id="admin-email" class="text-gray-700 font-medium hidden sm:block"></span>
        </div>
      </header>

      <!-- Loading Spinner -->
      <div id="main-loading-spinner" class="flex justify-center items-center h-[50vh] text-gray-500 hidden">
        <div class="w-16 h-16 border-4 border-gray-300 border-t-pink-500 rounded-full spinner"></div>
      </div>
      
      <!-- Dashboard Tab -->
      <div id="dashboard-tab" class="tab-content">
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">মোট ব্যবহারকারী</div>
            <div id="total-users" class="text-4xl font-bold mt-2 text-purple-700">0</div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">মোট গণনা</div>
            <div id="total-calculations" class="text-4xl font-bold mt-2 text-purple-700">0</div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">আজকের কার্যকলাপ</div>
            <div id="today-activity" class="text-4xl font-bold mt-2 text-purple-700">0</div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-transform duration-300 hover:scale-105">
            <div class="text-gray-500 text-sm font-medium">গড় প্রেম শতাংশ</div>
            <div id="avg-percentage" class="text-4xl font-bold mt-2 text-purple-700">0%</div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-purple-800 mb-4">সাম্প্রতিক গণনা</h2>
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead>
                <tr class="bg-purple-800 text-white rounded-t-lg">
                  <th class="px-4 py-3 text-left rounded-tl-xl">ব্যবহারকারী</th>
                  <th class="px-4 py-3 text-left">নাম</th>
                  <th class="px-4 py-3 text-left">শতাংশ</th>
                  <th class="px-4 py-3 text-left rounded-tr-xl">সময়</th>
                </tr>
              </thead>
              <tbody id="latest-calculations" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users-tab" class="tab-content hidden">
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input type="text" id="user-search" placeholder="ব্যবহারকারী অনুসন্ধান করুন..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm">
          <button id="search-user-btn" class="bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md">অনুসন্ধান</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-purple-800 text-white rounded-t-lg">
                <th class="px-4 py-3 text-left rounded-tl-xl">ইমেল</th>
                <th class="px-4 py-3 text-left">সাইন আপ তারিখ</th>
                <th class="px-4 py-3 text-left">গণনা</th>
                <th class="px-4 py-3 text-left rounded-tr-xl">কার্যকলাপ</th>
              </tr>
            </thead>
            <tbody id="users-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Activity Tab -->
      <div id="activity-tab" class="tab-content hidden">
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input type="text" id="activity-search" placeholder="সাম্প্রতিক কার্যকলাপ অনুসন্ধান করুন..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm">
          <button id="search-activity-btn" class="bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md">অনুসন্ধান</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-purple-800 text-white rounded-t-lg">
                <th class="px-4 py-3 text-left rounded-tl-xl">ব্যবহারকারী</th>
                <th class="px-4 py-3 text-left">নাম</th>
                <th class="px-4 py-3 text-left">শতাংশ</th>
                <th class="px-4 py-3 text-left rounded-tr-xl">সময়</th>
              </tr>
            </thead>
            <tbody id="activity-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      
      <!-- All History Tab -->
      <div id="history-tab" class="tab-content hidden">
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input type="text" id="history-search" placeholder="হিস্টরি অনুসন্ধান করুন..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 shadow-sm">
          <button id="search-history-btn" class="bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md">অনুসন্ধান</button>
          <button id="clear-history-btn" class="bg-red-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-600 transition-all duration-300 transform hover:scale-105 shadow-md">সব হিস্টরি মুছে ফেলুন</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-purple-800 text-white rounded-t-lg">
                <th class="px-4 py-3 text-left rounded-tl-xl">ব্যবহারকারী</th>
                <th class="px-4 py-3 text-left">নাম</th>
                <th class="px-4 py-3 text-left">শতাংশ</th>
                <th class="px-4 py-3 text-left">সময়</th>
                <th class="px-4 py-3 text-left rounded-tr-xl">কার্যকলাপ</th>
              </tr>
            </thead>
            <tbody id="history-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Custom Confirmation Modal -->
  <div id="confirmation-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-3xl p-8 shadow-2xl max-w-sm w-full modal-content">
      <h3 class="text-xl font-bold text-gray-800 mb-4">নিশ্চিত করুন</h3>
      <p id="modal-text" class="text-gray-600 mb-6">আপনি কি এই কাজটি করতে চান?</p>
      <div class="flex justify-end space-x-4">
        <button id="cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold hover:bg-gray-400 transition-colors duration-200">বাতিল</button>
        <button id="confirm-btn" class="bg-red-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-red-600 transition-colors duration-200">নিশ্চিত করুন</button>
      </div>
    </div>
  </div>
  
  <!-- Loading Spinner Modal -->
  <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl">
      <div class="w-10 h-10 border-4 border-purple-500 border-t-transparent border-solid rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-700 font-medium">প্রক্রিয়াকরণ হচ্ছে...</p>
    </div>
  </div>

  <!-- Firebase SDK and custom script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, onSnapshot, collection, query, where, deleteDoc, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Load Firebase configuration and auth token from global variables
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Admin login specific elements
    const loginContainer = document.getElementById('login-container');
    const adminPanel = document.getElementById('admin-panel');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const loadingModal = document.getElementById('loading-modal');

    // Admin panel specific elements
    const sidebarLinks = document.querySelectorAll('a[data-tab]');
    const tabContents = document.querySelectorAll('.tab-content');
    const pageTitleEl = document.getElementById('page-title');
    const logoutBtn = document.getElementById('logout-btn');
    const adminPhoto = document.getElementById('admin-photo');
    const adminEmailEl = document.getElementById('admin-email');
    const mainLoadingSpinner = document.getElementById('main-loading-spinner');
    
    // Dashboard elements
    const totalUsersEl = document.getElementById('total-users');
    const totalCalculationsEl = document.getElementById('total-calculations');
    const todayActivityEl = document.getElementById('today-activity');
    const avgPercentageEl = document.getElementById('avg-percentage');
    const latestCalculationsEl = document.getElementById('latest-calculations');
    
    // Users tab elements
    const userSearchInput = document.getElementById('user-search');
    const searchUserBtn = document.getElementById('search-user-btn');
    const usersListEl = document.getElementById('users-list');
    
    // Activity tab elements
    const activitySearchInput = document.getElementById('activity-search');
    const searchActivityBtn = document.getElementById('search-activity-btn');
    const activityListEl = document.getElementById('activity-list');
    
    // History tab elements
    const historySearchInput = document.getElementById('history-search');
    const searchHistoryBtn = document.getElementById('search-history-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const historyListEl = document.getElementById('history-list');
    
    // Custom modal elements
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalText = document.getElementById('modal-text');
    const confirmBtn = document.getElementById('confirm-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    
    // Global state
    let currentAdmin = null;
    let usersData = [];
    let allHistoryData = [];
    let isInitialDataLoaded = false; // Flag to track initial data load

    // Only this email is allowed to be an admin
    const ADMIN_EMAIL = "smartwork19999@gmail.com";
    
    // Custom message box function
    function showMessage(message, type = 'error') {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
      errorMessage.classList.remove('border-red-400', 'border-green-400');
      errorMessage.classList.remove('text-red-700', 'text-green-700');
      if (type === 'error') {
        errorMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
      } else {
        errorMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
      }
      errorMessage.classList.remove('hidden'); // Ensure it's visible
    }

    // Function to show/hide sections based on login status
    function showAdminPanel(show) {
        if (show) {
            loginContainer.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        } else {
            loginContainer.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        }
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
        // The Canvas environment handles the initial sign-in with a custom token.
        // We only need to react to the user object's presence and email.
        if (user && user.email === ADMIN_EMAIL) {
            currentAdmin = user;
            adminEmailEl.textContent = user.email;
            adminEmailEl.classList.remove('hidden');
            if (user.photoURL) {
                adminPhoto.src = user.photoURL;
            }
            showAdminPanel(true);
            // Only load data once after successful login
            if (!isInitialDataLoaded) {
                await loadInitialData();
                isInitialDataLoaded = true;
            }
            switchTab('dashboard');
        } else {
            // If user exists but is not ADMIN_EMAIL, log them out
            if (user) {
              await signOut(auth); 
              showMessage('আপনি অ্যাডমিন নন।'); // Inform user
            }
            currentAdmin = null;
            showAdminPanel(false);
            errorMessage.classList.add('hidden'); // Hide previous error messages on logout/failed login
        }
    });

    // Google Login
    googleLoginBtn.addEventListener('click', async () => {
        errorMessage.classList.add('hidden'); // Hide any previous error messages
        loadingModal.classList.remove('hidden');
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            if (user.email !== ADMIN_EMAIL) {
                await signOut(auth); // Log out immediately if not the admin
                showMessage('আপনি অ্যাডমিন নন।');
            }
            // If it's the admin, onAuthStateChanged will handle displaying the panel
        } catch (error) {
            let message = 'গুগল লগইন ব্যর্থ হয়েছে।';
            if (error.code === 'auth/popup-closed-by-user') {
                message = 'লগইন পপআপ বন্ধ করা হয়েছে।';
            } else if (error.code === 'auth/cancelled-popup-request') {
                message = 'অন্য একটি পপআপ লগইন প্রক্রিয়া চলছে।';
            }
            showMessage(message);
            console.error("Google login error:", error);
        } finally {
            loadingModal.classList.add('hidden');
        }
    });

    // All data loader
    async function loadInitialData() {
      mainLoadingSpinner.classList.remove('hidden');
      
      // Use a promise to ensure both onSnapshot listeners have fired at least once
      const dataLoadPromise = new Promise(resolve => {
        let usersSnapshotReceived = false;
        let historySnapshotReceived = false;

        const checkCompletion = () => {
          if (usersSnapshotReceived && historySnapshotReceived) {
            resolve();
          }
        };

        onSnapshot(collection(db, `artifacts/${appId}/public/users`), (snapshot) => {
          usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          loadDashboardData();
          renderUsersList();
          usersSnapshotReceived = true;
          checkCompletion();
        });
        
        onSnapshot(collectionGroup(db, 'history'), (snapshot) => {
          allHistoryData = snapshot.docs.map(doc => {
            const path = doc.ref.path.split('/');
            const userId = path[3];
            return { id: doc.id, userId: userId, ...doc.data() };
          });
          loadDashboardData();
          renderHistoryList();
          historySnapshotReceived = true;
          checkCompletion();
        });
      });
      
      await dataLoadPromise;
      mainLoadingSpinner.classList.add('hidden');
    }

    // Dashboard Data
    function loadDashboardData() {
      const totalUsers = usersData.length;
      totalUsersEl.textContent = totalUsers;
      
      const totalCalculations = allHistoryData.length;
      totalCalculationsEl.textContent = totalCalculations;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayActivityCount = allHistoryData.filter(h => h.timestamp?.toDate() >= today).length;
      todayActivityEl.textContent = todayActivityCount;
      
      const totalPercentage = allHistoryData.reduce((sum, h) => sum + (h.percentage || 0), 0);
      const avgPercentage = totalCalculations > 0 ? (totalPercentage / totalCalculations).toFixed(2) : 0;
      avgPercentageEl.textContent = `${avgPercentage}%`;
      
      renderLatestCalculations();
    }
    
    // Render latest calculations
    function renderLatestCalculations() {
      latestCalculationsEl.innerHTML = '';
      const latest = allHistoryData.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).slice(0, 5); // Display top 5 latest calculations
      
      if (latest.length === 0) {
        latestCalculationsEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">কোন সাম্প্রতিক গণনা পাওয়া যায়নি।</td></tr>`;
        return;
      }

      latest.forEach(calc => {
        const user = usersData.find(u => u.id === calc.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${calc.loverName || 'অজানা'} ❤️ ${calc.partnerName || 'অজানা'}`;
        const time = calc.timestamp?.toDate().toLocaleString() || 'অজানা';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${userEmail}</td>
          <td class="px-4 py-3">${names}</td>
          <td class="px-4 py-3 font-semibold text-pink-600">${calc.percentage}%</td>
          <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
        `;
        latestCalculationsEl.appendChild(row);
      });
    }

    // Render users list
    function renderUsersList(searchTerm = '') {
      usersListEl.innerHTML = '';
      const filteredUsers = usersData.filter(user => 
        !searchTerm || (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      
      if (filteredUsers.length === 0) {
          usersListEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">কোন ব্যবহারকারী পাওয়া যায়নি।</td></tr>`;
          return;
      }

      filteredUsers.forEach(user => {
        const signUpDate = user.signUpDate?.toDate().toLocaleDateString() || 'অজানা';
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${user.email || 'অজানা'}</td>
          <td class="px-4 py-3 text-sm text-gray-500">${signUpDate}</td>
          <td class="px-4 py-3 font-semibold">${user.calculationCount || 0}</td>
          <td class="px-4 py-3 space-x-2">
            <button class="bg-purple-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-600 transition-colors duration-200 view-user-btn" data-id="${user.id}">দেখুন</button>
            <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-600 transition-colors duration-200 delete-user-btn" data-id="${user.id}">মুছে ফেলুন</button>
          </td>
        `;
        usersListEl.appendChild(row);
      });
    }
    
    // Render activity list
    function renderActivityList(searchTerm = '') {
      activityListEl.innerHTML = '';
      // Activity tab specifically shows "recent" activity, usually last few hundreds or today's
      const recentActivity = allHistoryData.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).slice(0, 100); // Show max 100 recent activities
      
      const filteredActivity = recentActivity.filter(activity => 
        !searchTerm || 
        (activity.loverName && activity.loverName.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (activity.partnerName && activity.partnerName.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (usersData.find(u => u.id === activity.userId)?.email && usersData.find(u => u.id === activity.userId).email.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      
      if (filteredActivity.length === 0) {
        activityListEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">কোন কার্যকলাপ পাওয়া যায়নি।</td></tr>`;
        return;
      }
      
      filteredActivity.forEach(activity => {
        const user = usersData.find(u => u.id === activity.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${activity.loverName || 'অজানা'} ❤️ ${activity.partnerName || 'অজানা'}`;
        const time = activity.timestamp?.toDate().toLocaleString() || 'অজানা';
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${userEmail}</td>
          <td class="px-4 py-3">${names}</td>
          <td class="px-4 py-3 font-semibold text-pink-600">${activity.percentage}%</td>
          <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
        `;
        activityListEl.appendChild(row);
      });
    }

    // Render history list
    function renderHistoryList(userId = null, searchTerm = '') {
      historyListEl.innerHTML = '';
      let filteredHistory = allHistoryData;
      
      if (userId) {
        filteredHistory = allHistoryData.filter(h => h.userId === userId);
      }
      
      if (searchTerm) {
        filteredHistory = filteredHistory.filter(h => 
          (h.loverName && h.loverName.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (h.partnerName && h.partnerName.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (usersData.find(u => u.id === h.userId)?.email && usersData.find(u => u.id === h.userId).email.toLowerCase().includes(searchTerm.toLowerCase()))
        );
      }

      // Sort by timestamp descending
      filteredHistory.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

      if (filteredHistory.length === 0) {
          historyListEl.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">কোন হিস্টরি পাওয়া যায়নি।</td></tr>`;
          return;
      }

      filteredHistory.forEach(historyItem => {
        const user = usersData.find(u => u.id === historyItem.userId);
        const userEmail = user?.email || 'অজানা ব্যবহারকারী';
        const names = `${historyItem.loverName || 'অজানা'} ❤️ ${historyItem.partnerName || 'অজানা'}`;
        const time = historyItem.timestamp?.toDate().toLocaleString() || 'অজানা';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-200';
        row.innerHTML = `
          <td class="px-4 py-3">${userEmail}</td>
          <td class="px-4 py-3">${names}</td>
          <td class="px-4 py-3 font-semibold text-pink-600">${historyItem.percentage}%</td>
          <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
          <td class="px-4 py-3">
            <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-600 transition-colors duration-200 delete-history-btn" data-id="${historyItem.id}" data-userid="${historyItem.userId}">মুছে ফেলুন</button>
          </td>
        `;
        historyListEl.appendChild(row);
      });
    }

    // Switch tabs
    function switchTab(tabId) {
      sidebarLinks.forEach(link => {
        link.classList.remove('active-link');
        if (link.dataset.tab === tabId) {
          link.classList.add('active-link');
          pageTitleEl.textContent = link.querySelector('span:last-child').textContent;
        }
      });
      tabContents.forEach(content => {
        if (content.id === `${tabId}-tab`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    }
    
    // Show confirmation modal
    function showConfirmation(message, onConfirm) {
      modalText.textContent = message;
      confirmationModal.classList.remove('hidden');
      
      // Use a one-time event listener to prevent multiple calls
      const confirmListener = (e) => {
        confirmBtn.removeEventListener('click', confirmListener);
        cancelBtn.removeEventListener('click', cancelListener);
        confirmationModal.classList.add('hidden');
        onConfirm();
      };
      
      const cancelListener = (e) => {
        confirmBtn.removeEventListener('click', confirmListener);
        cancelBtn.removeEventListener('click', cancelListener);
        confirmationModal.classList.add('hidden');
      };

      // Add fresh listeners
      confirmBtn.addEventListener('click', confirmListener);
      cancelBtn.addEventListener('click', cancelListener);
    }

    // Event listeners
    sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });
    
    // Logout
    logoutBtn.addEventListener('click', async () => {
      loadingModal.classList.remove('hidden'); // Show loading spinner
      try {
        await signOut(auth);
        isInitialDataLoaded = false; // Reset the flag on logout
      } catch (error) {
        console.error("Logout failed:", error);
        showMessage('লগআউট ব্যর্থ হয়েছে।', 'error');
      } finally {
        loadingModal.classList.add('hidden'); // Hide loading spinner
      }
    });

    // Users search
    searchUserBtn.addEventListener('click', () => {
      renderUsersList(userSearchInput.value.trim());
    });
    userSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderUsersList(userSearchInput.value.trim());
    });
    
    // Activity search
    searchActivityBtn.addEventListener('click', () => {
      renderActivityList(activitySearchInput.value.trim());
    });
    activitySearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderActivityList(activitySearchInput.value.trim());
    });
    
    // History search
    searchHistoryBtn.addEventListener('click', () => {
      renderHistoryList(null, historySearchInput.value.trim());
    });
    historySearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderHistoryList(null, historySearchInput.value.trim());
    });
    
    // Clear all history
    clearHistoryBtn.addEventListener('click', () => {
      showConfirmation('আপনি কি সমস্ত হিস্টরি মুছে ফেলতে চান? এই কাজটি আর ফিরিয়ে আনা যাবে না।', async () => {
        loadingModal.classList.remove('hidden');
        try {
          const historySnap = await getDocs(collectionGroup(db, 'history'));
          const batch = writeBatch(db);
          
          if (historySnap.empty) {
            showMessage('মুছে ফেলার জন্য কোন হিস্টরি পাওয়া যায়নি।', 'info');
            loadingModal.classList.add('hidden');
            return;
          }

          // Delete all history documents
          historySnap.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          // Update all user calculation counts to 0
          usersData.forEach(user => {
              const userRef = doc(db, `artifacts/${appId}/public/users/${user.id}`);
              batch.update(userRef, { calculationCount: 0 });
          });

          await batch.commit();
          showMessage('সমস্ত হিস্টরি সফলভাবে মুছে ফেলা হয়েছে।', 'success');
        } catch (error) {
          console.error("Error clearing all history:", error);
          showMessage('সব হিস্টরি মুছে ফেলা যায়নি। আবার চেষ্টা করুন।', 'error');
        } finally {
          loadingModal.classList.add('hidden');
        }
      });
    });

    // Dynamic event listener for table buttons
    document.body.addEventListener('click', async (e) => {
      // Delete user
      if (e.target.classList.contains('delete-user-btn')) {
        const userId = e.target.dataset.id;
        showConfirmation('আপনি কি এই ব্যবহারকারীকে এবং তার সমস্ত ডেটা মুছে ফেলতে চান?', async () => {
          loadingModal.classList.remove('hidden');
          try {
            const batch = writeBatch(db);
            const userRef = doc(db, `artifacts/${appId}/public/users/${userId}`);
            const historySnap = await getDocs(collection(userRef, 'history'));
            historySnap.forEach(doc => batch.delete(doc.ref));
            batch.delete(userRef);
            await batch.commit();
            showMessage('ব্যবহারকারী এবং তাদের ডেটা সফলভাবে মুছে ফেলা হয়েছে।', 'success');
          } catch (error) {
            console.error("Error deleting user:", error);
            showMessage('ব্যবহারকারী মুছে ফেলা যায়নি। আবার চেষ্টা করুন।', 'error');
          } finally {
            loadingModal.classList.add('hidden');
          }
        });
      }
      // View user history
      if (e.target.classList.contains('view-user-btn')) {
        const userId = e.target.dataset.id;
        historySearchInput.value = ''; // Clear search when viewing specific user history
        switchTab('history');
        renderHistoryList(userId);
      }
      // Delete history item
      if (e.target.classList.contains('delete-history-btn')) {
        const historyId = e.target.dataset.id;
        const userId = e.target.dataset.userid;
        showConfirmation('আপনি কি এই হিস্টরি আইটেমটি মুছে ফেলতে চান?', async () => {
          loadingModal.classList.remove('hidden');
          try {
            const historyRef = doc(db, `artifacts/${appId}/public/users/${userId}/history/${historyId}`);
            await deleteDoc(historyRef);
            // After deleting a history item, we should also decrement the user's calculation count
            const userRef = doc(db, `artifacts/${appId}/public/users/${userId}`);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const currentCount = userDoc.data().calculationCount || 0;
                await updateDoc(userRef, { calculationCount: Math.max(0, currentCount - 1) });
            }
            showMessage('হিস্টরি আইটেম সফলভাবে মুছে ফেলা হয়েছে।', 'success');
          } catch (error) {
            console.error("Error deleting history item:", error);
            showMessage('হিস্টরি আইটেম মুছে ফেলা যায়নি। আবার চেষ্টা করুন।', 'error');
          } finally {
            loadingModal.classList.add('hidden');
          }
        });
      }
    });
  </script>
</body>
</html>
